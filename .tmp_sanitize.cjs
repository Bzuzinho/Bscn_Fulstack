const fs = require('fs');
const path = require('path');
const SRC = path.resolve('drizzle_preview/0000_preview_ficha.sql');
const OUT = path.resolve('backend/database/migrations/2025_11_10_000001_sanitized_preview.sql');
if(!fs.existsSync(SRC)){
  console.error('Source preview not found at', SRC);
  process.exit(2);
}
const src = fs.readFileSync(SRC,'utf8').split('\n');
const out = [];
out.push('-- Sanitized migration generated from ' + SRC + ' on ' + new Date().toISOString());
out.push('-- Lines matching DROP, CREATE SEQUENCE, ALTER ... ADD GENERATED ALWAYS AS IDENTITY, and other destructive ops are commented out to avoid conflicts');
const patterns = [
  /CREATE SEQUENCE/i,
  /ADD GENERATED ALWAYS AS IDENTITY/i,
  /ADD GENERATED BY DEFAULT AS IDENTITY/i,
  /ALTER TABLE .*ADD GENERATED/i,
  /^\s*DROP TABLE/i,
  /^\s*DROP INDEX/i,
  /ALTER TABLE .*DROP COLUMN/i,
  /ALTER TABLE .*DROP CONSTRAINT/i,
  /DROP CONSTRAINT/i
];
for(const line of src){
  let skip = false;
  for(const p of patterns){ if(p.test(line)){ skip = true; break; } }
  if(skip){ out.push('-- SKIPPED: '+line); }
  else { out.push(line); }
}
fs.mkdirSync(path.dirname(OUT), { recursive: true });
fs.writeFileSync(OUT, out.join('\n'));
// git add and commit
const { execSync } = require('child_process');
try{
  execSync('git add ' + OUT.replace(/'/g,"'\\''"));
  execSync('git commit -m "chore(db): sanitized preview migration to avoid identity/sequence conflicts" || true', { stdio: 'inherit' });
  console.log('Sanitized migration written to', OUT);
}catch(e){ console.error('Git commit failed (ok if already committed):', e.message); }
